<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragment/default}">

<head>
    <th:block layout:fragment="css">
        <link rel="stylesheet" th:href="@{/css/master/shopEdit.css}">
    </th:block>
</head>

<body>
<div layout:fragment="main" id="main">
    <div class="section-container">
        <h3>ë§¤ì¥ ì •ë³´ ìˆ˜ì •</h3>
        <div class="customer-card">
            <form  th:object="${shop}">
                <input type="hidden" th:field="*{id}" />


                <div class="customer-header">
                    <strong>ë§¤ì¥ëª…</strong>
                    <input type="text" th:field="*{name}" placeholder="ë§¤ì¥ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" required />
                </div>

                <div class="customer-header">
                    <strong>ì—°ë½ì²˜</strong>
                    <input type="text" th:field="*{tel}" placeholder="ì „í™”ë²ˆí˜¸ ì…ë ¥" />
                </div>

                <div class="customer-header">
                    <strong>ì£¼ì†Œ</strong>
                    <div class="address-wrapper">
                        <div class="address-row">
                            <input type="text" id="postcode" placeholder="ìš°í¸ë²ˆí˜¸" readonly />
                            <button type="button" class="btn-search-address" onclick="execDaumPostcode()">ìš°í¸ë²ˆí˜¸ ì°¾ê¸°</button>
                        </div>

                        <input type="text" id="roadAddress" placeholder="ë„ë¡œëª…ì£¼ì†Œ" th:value="*{address}" readonly />

                        <div class="address-row">
                            <input type="text" id="detailAddress" th:field="*{addressDetail}" placeholder="ìƒì„¸ì£¼ì†Œ ì…ë ¥" />
                            <input type="text" id="extraAddress" placeholder="ì°¸ê³ í•­ëª©" readonly />
                        </div>

                        <input type="hidden" th:field="*{latitude}" />
                        <input type="hidden" th:field="*{longitude}" />
                        <input type="hidden" th:field="*{address}" id="fullAddress" />
                    </div>
                </div>

                <div id="addressModal" class="modal">
                    <div class="modal-content">
                        <div id="daumWrap" style="width:100%;height:100%;"></div>
                    </div>
                </div>

                <div class="customer-header">
                    <strong>ìš´ì˜ì‹œê°„</strong>
                    <input type="time" name="openTime" id="openTime" th:value="${#temporals.format(shop.openTime, 'HH:mm')}" />
                    <input type="time" name="closeTime" id="closeTime" th:value="${#temporals.format(shop.closeTime, 'HH:mm')}" />
                </div>

                <div class="customer-header">
                    <strong>ì§€ê° ê¸°ì¤€ (ë¶„)</strong>
                    <input type="number" th:field="*{lateMin}" min="0" />
                </div>

                <div class="customer-header">
                    <strong>ì¡°í‡´ ê¸°ì¤€ (ë¶„)</strong>
                    <input type="number" th:field="*{earlyLeaveMin}" min="0" />
                </div>

                <div class="customer-header">
                    <strong>ì˜ˆì•½ ê°„ê²© (ë¶„)</strong>
                    <input type="number" th:field="*{reservationInterval}" min="10" step="5" />
                </div>

                <div class="customer-header">
                    <strong>ë§ˆê° ì „ ì˜ˆì•½ ì œí•œì‹œê°„ (ë¶„)</strong>
                    <input type="number" th:field="*{timeBeforeClosing}" min="0" />
                </div>

                <div class="customer-header">
                    <strong>íœ´ë¬´ ìš”ì¼</strong>
                    <select th:field="*{dayOff}">
                        <option value="0">ì—†ìŒ</option>
                        <option value="1">ì›”ìš”ì¼</option>
                        <option value="2">í™”ìš”ì¼</option>
                        <option value="4">ìˆ˜ìš”ì¼</option>
                        <option value="8">ëª©ìš”ì¼</option>
                        <option value="16">ê¸ˆìš”ì¼</option>
                        <option value="32">í† ìš”ì¼</option>
                        <option value="64">ì¼ìš”ì¼</option>
                    </select>
                </div>

                <div class="customer-header">
                    <strong>ë§¤ì¥ ì†Œê°œ</strong>
                    <textarea th:field="*{description}" placeholder="ë§¤ì¥ ì„¤ëª… ì…ë ¥"></textarea>
                </div>
            </form>
            <form id="shop-edit-form"  enctype="multipart/form-data" >
                <div class="customer-header">
                    <strong>ì‚¬ì§„ ì—…ë¡œë“œ</strong>
                    <div class="shop-image-upload">
                        <!-- ì—…ë¡œë“œ ë²„íŠ¼ -->
                        <input type="file" id="shopImageInput" name="files" multiple accept="image/*" />
                        <label for="shopImageInput" class="custom-upload-label">ğŸ“· ì‚¬ì§„ ì—…ë¡œë“œ</label>

                        <!-- ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ -->
                        <div id="shopImagePreview" class="image-preview-container">
                            <th:block th:each="image, iterStat : ${shop.shopImages}">
                                <div class="preview-image-wrapper" th:data-id="${image.id}">
                                    <img th:src="@{${image.imgUrl}}" class="preview-image" th:alt="${image.originalName}" />

                                    <!-- ì¸ë„¤ì¼ ì„ íƒìš© ë¼ë””ì˜¤ -->
                                    <input type="radio"
                                           name="thumbnailImageId"
                                           class="thumbnail-radio"
                                           th:value="${image.id}"
                                           th:checked="${image.isThumbnail} ? 'checked' : null" />

                                    <!-- ì‚­ì œ ë²„íŠ¼ -->
                                    <button type="button" class="btn-delete-img" th:data-id="${image.id}">Ã—</button>

                                </div>
                            </th:block>
                        </div>
                    </div>
                </div>

                <div style="text-align: right;">
                    <button type="button" class="btn-edit" onclick="submitShopEdit()">ì €ì¥í•˜ê¸°</button>
                </div>
            </form>
        </div>
    </div>
</div>

<th:block layout:fragment="script">
    <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=0bcfa737cae58afd2f78fe737895ea3b&autoload=false&libraries=services"></script>
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

    <script>
        // ì „ì—­ì— ë¯¸ë¦¬ í•¨ìˆ˜ ì„ ì–¸
        window.execDaumPostcode = function () {
          alert('ì£¼ì†Œì°¾ê¸° í•¨ìˆ˜ê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.');
        };

        let geocoder;

        // kakao.maps SDK ë¡œë“œ í›„ ì‹¤í–‰
        kakao.maps.load(function () {
          geocoder = new kakao.maps.services.Geocoder();

          // ì´ì œ execDaumPostcodeë¥¼ ì§„ì§œ í•¨ìˆ˜ë¡œ ë®ì–´ì“°ê¸°
          window.execDaumPostcode = function () {
            const modal = document.getElementById('addressModal');
            const daumWrap = document.getElementById('daumWrap');

            modal.style.display = 'block';

            new daum.Postcode({
              oncomplete: function(data) {
                let roadAddr = data.roadAddress;
                let extraAddr = '';

                if (data.bname !== '' && /[ë™|ë¡œ|ê°€]$/g.test(data.bname)) {
                  extraAddr += data.bname;
                }
                if (data.buildingName !== '' && data.apartment === 'Y') {
                  extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                }

                document.getElementById("postcode").value = data.zonecode;
                document.getElementById("roadAddress").value = roadAddr;
                document.getElementById("extraAddress").value = extraAddr;
                document.getElementById("fullAddress").value =
                  roadAddr + " " + document.getElementById("detailAddress").value;

                // ì¢Œí‘œ ë³€í™˜
                geocoder.addressSearch(roadAddr, function(result, status) {
                  if (status === kakao.maps.services.Status.OK) {
                    const lat = result[0].y;
                    const lng = result[0].x;

                    document.querySelector('input[name="latitude"]').value = lat;
                    document.querySelector('input[name="longitude"]').value = lng;
                  } else {
                    console.error('ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨:', status);
                  }
                });

                // ì ì‹œ í›„ ëª¨ë‹¬ ë‹«ê¸°
                setTimeout(closeDaumPostcode, 100);
              },
              width: '100%',
              height: '100%'
            }).embed(daumWrap);
          };

          function closeDaumPostcode() {
            document.getElementById('addressModal').style.display = 'none';
            document.getElementById('daumWrap').innerHTML = "";
          }

          // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
          window.addEventListener("click", function(event) {
            const modal = document.getElementById('addressModal');
            if (event.target === modal) {
              closeDaumPostcode();
            }
          });

          // ìƒì„¸ì£¼ì†Œ ì…ë ¥ ì‹œ ì „ì²´ ì£¼ì†Œ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
          const detailInput = document.getElementById("detailAddress");
          if (detailInput) {
            detailInput.addEventListener("input", function () {
              const road = document.getElementById("roadAddress").value;
              const detail = this.value;
              document.getElementById("fullAddress").value = road + " " + detail;
            });
          }
        });
    </script>

    <script>
        let selectedFiles = []; // ìƒˆë¡œ ì„ íƒí•œ íŒŒì¼ë“¤
        let deletedImageIds = []; // ê¸°ì¡´ ì´ë¯¸ì§€ ì‚­ì œ id ëª¨ìŒ
        let thumbnailRadioMap = new Map(); // ìƒˆ ì´ë¯¸ì§€ ì¸ë„¤ì¼ ë§¤í•‘ìš©

        // ê¸°ì¡´ ì´ë¯¸ì§€ ì‚­ì œ
        function deleteExistingImage(id) {
          console.log('ì‚­ì œ ìš”ì²­ id:', id);
          const imageDiv = document.querySelector(`.preview-image-wrapper[data-id="${id}"]`);
          if (imageDiv) {
            const wasChecked = imageDiv.querySelector('input.thumbnail-radio')?.checked || false;

            imageDiv.remove();
            deletedImageIds.push(Number(id));
            console.log('ì‚­ì œëœ ì´ë¯¸ì§€ ID ëª©ë¡:', deletedImageIds);

            if (wasChecked) {
              // ì¸ë„¤ì¼ ë¼ë””ì˜¤ê°€ ì‚­ì œëœ ê²½ìš°, ë‹¤ë¥¸ ë¼ë””ì˜¤ ì„ íƒ
              selectFirstAvailableThumbnail();
            }
          } else {
            console.warn('ì‚­ì œí•  ì´ë¯¸ì§€ ìš”ì†Œë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤:', id);
          }
        }

        // ì‚­ì œ í›„ ì¸ë„¤ì¼ ë¼ë””ì˜¤ ìµœì†Œ 1ê°œ ìœ ì§€ í•¨ìˆ˜
        function selectFirstAvailableThumbnail() {
          const radios = document.querySelectorAll('input.thumbnail-radio');
          if (radios.length === 0) return; // ë¼ë””ì˜¤ê°€ í•˜ë‚˜ë„ ì—†ìœ¼ë©´ í•  ìˆ˜ ì—†ìŒ

          const anyChecked = Array.from(radios).some(r => r.checked);
          if (!anyChecked) {
            radios[0].checked = true;
          }
        }

        // ìƒˆ ì´ë¯¸ì§€ ì„ íƒ ì‹œ ë¯¸ë¦¬ë³´ê¸° ì¶”ê°€
        document.getElementById('shopImageInput').addEventListener('change', function () {
            const preview = document.getElementById('shopImagePreview');
            const newFiles = Array.from(this.files);

            newFiles.forEach(file => {
                if (selectedFiles.some(f => f.name === file.name && f.size === file.size)) return;

                selectedFiles.push(file);

                const reader = new FileReader();
                reader.onload = function (e) {
                    const wrapper = document.createElement('div');
                    wrapper.classList.add('preview-image-wrapper');

                    // ê³ ìœ  ID: fileName + size (ë°±ì—”ë“œì—ì„œë„ ê³„ì‚° ê°€ëŠ¥)
                    const newId = `new_${file.name}_${file.size}`;
                    wrapper.setAttribute('data-id', newId);

                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.classList.add('preview-image');

                    const radio = document.createElement('input');
                    radio.type = 'radio';
                    radio.name = 'thumbnailImageId';
                    radio.classList.add('thumbnail-radio');
                    radio.value = newId;

                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerText = 'Ã—';
                    deleteBtn.classList.add('btn-delete-img');
                    deleteBtn.addEventListener('click', () => {
                        wrapper.remove();
                        selectedFiles = selectedFiles.filter(f => f !== file);
                    });

                    wrapper.appendChild(img);
                    wrapper.appendChild(radio);
                    wrapper.appendChild(deleteBtn);
                    document.getElementById('shopImagePreview').appendChild(wrapper);
                };
                reader.readAsDataURL(file);
            });


            this.value = '';
        });

        // ì‚­ì œ ë²„íŠ¼ ì²˜ë¦¬
        document.getElementById('shopImagePreview').addEventListener('click', e => {
            if (e.target.classList.contains('btn-delete-img')) {
                const wrapper = e.target.closest('.preview-image-wrapper');
                const id = wrapper?.getAttribute('data-id');

                if (id && !id.startsWith('new_')) {
                    deleteExistingImage(id); // ê¸°ì¡´ ì´ë¯¸ì§€
                } else {
                    wrapper?.remove(); // ìƒˆ ì´ë¯¸ì§€
                    selectedFiles = selectedFiles.filter((f, idx) => {
                        const fileId = [...thumbnailRadioMap.entries()].find(([k, v]) => v === f)?.[0];
                        return fileId !== id;
                    });
                    thumbnailRadioMap.delete(id);
                }
            }
        });

        // ì €ì¥ í•¨ìˆ˜
        function submitShopEdit() {
            const formData = new FormData();

            const shopData = {
                id: document.querySelector('input[name="id"]').value,
                name: document.querySelector('input[name="name"]').value,
                tel: document.querySelector('input[name="tel"]').value,
                address: document.querySelector('#roadAddress').value,
                addressDetail: document.querySelector('#detailAddress').value,
                latitude: document.querySelector('input[name="latitude"]').value,
                longitude: document.querySelector('input[name="longitude"]').value,
                openTime: document.querySelector('#openTime').value,
                closeTime: document.querySelector('#closeTime').value,
                lateMin: parseInt(document.querySelector('input[name="lateMin"]').value, 10),
                earlyLeaveMin: parseInt(document.querySelector('input[name="earlyLeaveMin"]').value, 10),
                reservationInterval: parseInt(document.querySelector('input[name="reservationInterval"]').value, 10),
                timeBeforeClosing: parseInt(document.querySelector('input[name="timeBeforeClosing"]').value, 10),
                dayOff: parseInt(document.querySelector('select[name="dayOff"]').value, 10),
                description: document.querySelector('textarea[name="description"]').value
            };

            formData.append('shopEditDto', JSON.stringify(shopData));

            // ì¸ë„¤ì¼ ë¼ë””ì˜¤ ì„ íƒ
            const thumbnailRadio = document.querySelector('input[name="thumbnailImageId"]:checked');
            const thumbnailId = thumbnailRadio ? thumbnailRadio.value : '';
            formData.append('thumbnailImageId', thumbnailId);

            // ìƒˆ ì´ë¯¸ì§€ ì¶”ê°€
            selectedFiles.forEach(file => {
                formData.append('files', file);
            });

            // ì‚­ì œëœ ì´ë¯¸ì§€ ID
            formData.append('deletedImageIds', JSON.stringify(deletedImageIds));

            console.log('ì¸ë„¤ì¼:', thumbnailId);
            console.log('ì‚­ì œ ID ëª©ë¡:', deletedImageIds);
            console.log('ì„ íƒëœ íŒŒì¼ë“¤:', selectedFiles);

            fetch('/master/shop-edit/update', {
                method: 'POST',
                body: formData
            }).then(response => {
                if (response.ok) {
                    alert('ì €ì¥ ì„±ê³µ!');
                    location.href = '/master';
                } else {
                    alert('ì €ì¥ ì‹¤íŒ¨');
                }
            }).catch(error => {
                console.error('ì „ì†¡ ì˜¤ë¥˜:', error);
            });
        }
    </script>


</th:block>

</body>
</html>